<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>攻守名單管理</title>
  <style>
    body { font-family: sans-serif; background: #fff; margin: 0; padding: 1rem; }
    .wrapper { max-width: 960px; margin: auto; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
    th, td { border: 1px solid #ccc; text-align: center; padding: 6px; }
    .title { text-align: center; font-size: 1.2rem; font-weight: bold; margin: 1rem 0; }
    .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
    .player { background: #e0f7fa; border: 1px solid #00796b; padding: 4px; border-radius: 4px; text-align: center; cursor: grab; }
    .sub-row { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
    input, select { width: 100%; padding: 4px; }
    .score { display: flex; justify-content: center; gap: 1rem; font-size: 1.5rem; font-weight: bold; }
  </style>
</head>
<body>
<div class="wrapper">
  <div class="title">吳興街友 雙和聯盟 B組 攻守名單</div>
  <table>
    <tr><td colspan="2">比賽日期</td><td colspan="2" id="date"></td><td>開賽時間</td><td id="start"></td></tr>
    <tr><td colspan="2">比賽對手</td><td colspan="2" id="opponent"></td><td>集合時間</td><td id="gather"></td></tr>
    <tr><td colspan="6" id="offdef"></td></tr>
  </table>
  <table>
    <thead><tr><th>打序</th><th>守位</th><th>姓名</th><th>背號</th></tr></thead>
    <tbody id="lineup"></tbody>
    <tr><td colspan="4">P</td></tr>
  </table>
  <div class="title">預備球員</div>
  <div id="bench" class="grid"></div>
  <div class="title">球員更換</div>
  <div class="sub-row">
    <div><label>換下</label><select id="sub-out"></select></div>
    <div><label>換上</label><select id="sub-in"></select></div>
    <div style="align-self: end;"><button onclick="substitute()">執行換人</button></div>
  </div>
  <div class="title">守位輪換</div>
  <input type="text" id="rotate-input" placeholder="例如：8918" />
  <button onclick="rotatePositions()" style="margin-top:0.5rem;width:100%;">執行輪換</button>
  <div class="title">比數</div>
  <div class="score">
    <input type="number" id="score1" value="0"/>:<input type="number" id="score2" value="0"/>
  </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script>
const sheetCSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTeA--X7L0ZCeQvqXvxZjLatdC_yCCJy2QHStokg6pRbBqRC6mBNWf3f03O5U3UHBgxFaIl47K39m8R/pub?output=csv';
let players = [], lineup = [];

fetch(sheetCSV)
  .then(res => res.text())
  .then(csv => {
    const parsed = Papa.parse(csv, { header: true });
    const rows = parsed.data;
    const info = rows.find(r => r['雙和聯盟'] !== undefined);
    if(info){
      document.getElementById('date').textContent = info['比賽日期'] || '';
      document.getElementById('start').textContent = info['開賽時間'] || '';
      document.getElementById('gather').textContent = info['集合時間'] || '';
      document.getElementById('opponent').textContent = info['對手'] || '';
      document.getElementById('offdef').textContent = '攻守：' + (info['攻守'] || '');
    }
    players = rows.filter(p => p['出席'] === 'Y' && p['背號'] && p['姓名']);
    renderBench();
  });

function renderBench(){
  const bench = document.getElementById('bench');
  bench.innerHTML = '';
  players.forEach(p => {
    const div = document.createElement('div');
    div.className = 'player';
    div.textContent = `#${p['背號']} ${p['姓名']}`;
    div.draggable = true;
    div.dataset.number = p['背號'];
    div.dataset.name = p['姓名'];
    div.addEventListener('dragstart', e => {
      e.dataTransfer.setData('text/plain', JSON.stringify(p));
    });
    bench.appendChild(div);
  });
  updateSubDropdowns();
}

const lineupTable = document.getElementById('lineup');
lineupTable.addEventListener('dragover', e => e.preventDefault());
lineupTable.addEventListener('drop', e => {
  e.preventDefault();
  const p = JSON.parse(e.dataTransfer.getData('text/plain'));
  lineup.push(p);
  players = players.filter(x => x['背號'] !== p['背號']);
  renderLineup();
  renderBench();
});

function renderLineup(){
  lineupTable.innerHTML = '';
  lineup.forEach((p, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td><select><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>DH</option></select></td><td>${p['姓名']}</td><td>${p['背號']}</td>`;
    lineupTable.appendChild(tr);
  });
  updateSubDropdowns();
}

function updateSubDropdowns(){
  const outSel = document.getElementById('sub-out');
  const inSel = document.getElementById('sub-in');
  outSel.innerHTML = '';
  inSel.innerHTML = '';
  lineup.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p['背號'];
    opt.text = `#${p['背號']} ${p['姓名']}`;
    outSel.appendChild(opt);
  });
  players.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p['背號'];
    opt.text = `#${p['背號']} ${p['姓名']}`;
    inSel.appendChild(opt);
  });
}

function substitute(){
  const outNum = document.getElementById('sub-out').value;
  const inNum = document.getElementById('sub-in').value;
  const outIdx = lineup.findIndex(p => p['背號'] === outNum);
  const inPlayer = players.find(p => p['背號'] === inNum);
  if(outIdx === -1 || !inPlayer) return;
  players = players.filter(p => p['背號'] !== inNum);
  players.push(lineup[outIdx]);
  lineup[outIdx] = inPlayer;
  renderLineup();
  renderBench();
}

function rotatePositions(){
  const str = document.getElementById('rotate-input').value;
  if(!str) return;
  const seq = str.trim().split('');
  const selects = document.querySelectorAll('#lineup select');
  const map = {};
  selects.forEach(s => map[s.value] = s);
  for(let i=0; i<seq.length-1; i++){
    if(map[seq[i]]) map[seq[i]].value = seq[i+1];
  }
  if(map[seq[seq.length-1]]) map[seq[seq.length-1]].value = seq[0];
}
</script>
</body>
</html>
